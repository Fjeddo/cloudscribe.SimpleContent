$(function(){String.format=function(){for(var i,t=arguments[0],n=0;n<arguments.length-1;n++)i=new RegExp("\\{"+n+"\\}","gm"),t=t.replace(i,arguments[n+1]);return t};var n={ui:{treeDiv:$("#tree1"),cmdBarDiv:$("#cmdBar"),selectedPageInput:$("#hdnSelPage"),cmdHeading:$("#cmdHeading"),sortLi:$("#liSort"),editLi:$("#liEdit"),deleteLi:$("#liDelete"),newChildLi:$("#liNewChild"),editLink:$("#lnkEdit"),viewLink:$("#lnkView"),sortButton:$("#lnkSort"),newChildLink:$("#lnkNewChild"),deleteButton:$("#lnkDeletePage"),pubStatusLabel:$("#spnPubStatus"),movePagePromptFormat:$("#config").data("move-prompt-format"),deletePagePromptFormat:$("#config").data("delete-prompt-format"),deletePageWithChildrenPromptFormat:$("#config").data("delete-with-children-prompt-format"),sortChildrenAlphaPagePromptFormat:$("#config").data("sort-children-alpha-prompt-format")},urls:{treeDataUrl:$("#config").data("service-url"),sortUrl:$("#config").data("sort-url"),moveUrl:$("#config").data("move-url"),deleteUrl:$("#config").data("delete-url"),editUrl:$("#config").data("edit-url")},xsrfToken:$('[name="__RequestVerificationToken"]:first').val(),showCommands:function(t){n.ui.selectedPageInput.val(t.id);n.ui.cmdHeading.html(t.name);n.ui.editLink.attr("href",this.urls.editUrl+"/"+t.slug);n.ui.viewLink.attr("href",t.url);n.ui.newChildLink.attr("href",this.urls.editUrl+"?parentslug="+t.slug);n.ui.pubStatusLabel.html(t.pubstatus);n.ui.cmdBarDiv.show();new Tether({element:".commandPanel",target:".jqtree-selected",attachment:"top left",targetAttachment:"top right"});t.childcount>1?n.ui.sortLi.show():n.ui.sortLi.hide();t.canEdit?n.ui.editLi.show():n.ui.editLi.hide();t.canDelete?n.ui.deleteLi.show():n.ui.deleteLi.hide();t.canCreateChild?n.ui.newChildLi.show():n.ui.newChildLi.hide()},moveNode:function(t,i,r,u){var f={},e;return f.movedNode=t.id,f.targetNode=i.id,f.previousParent=r.id,f.position=u,e=!1,$.ajax({type:"POST",url:n.urls.moveUrl,async:!1,headers:{"X-XSRF-TOKEN":this.xsrfToken},dataType:"json",data:f,success:function(n){n.success?e=!0:alert(n.message)},complete:function(){},error:function(n,t,i){alert(i)}}),e},init:function(){this.ui.sortButton.click(function(t){var i,u,r;t.preventDefault();i=n.ui.treeDiv.tree("getNodeById",n.ui.selectedPageInput.val());u=String.format(n.ui.sortChildrenAlphaPagePromptFormat,i.name);confirm(u)&&(r={},r.pageId=i.id,$.ajax({type:"POST",url:n.urls.sortUrl,headers:{"X-XSRF-TOKEN":n.xsrfToken},async:!1,processData:!0,dataType:"json",data:r,success:function(t){t.success?n.ui.treeDiv.tree("loadDataFromUrl",i):alert(t.message)},complete:function(){},error:function(n,t,i){alert(i)}}))});n.ui.deleteButton.click(function(t){var i,r,f,e,u;t.preventDefault();i=n.ui.treeDiv.tree("getNodeById",n.ui.selectedPageInput.val());r=!1;i.childcount>0?(f=String.format(n.ui.deletePageWithChildrenPromptFormat,i.name,i.name),confirm(f)&&(r=!0)):(e=String.format(n.ui.deletePagePromptFormat,i.name),confirm(e)&&(r=!0));r&&(u={},u.id=i.id,$.ajax({type:"POST",url:n.urls.deleteUrl,headers:{"X-XSRF-TOKEN":n.xsrfToken},async:!1,dataType:"json",data:u,success:function(t){t.success?(n.ui.treeDiv.tree("removeNode",i),n.ui.cmdBarDiv.hide()):alert(t.message)},complete:function(){},error:function(n,t){alert(t)}}))});n.ui.treeDiv.tree({dataUrl:n.urls.treeDataUrl,dragAndDrop:!0,onLoadFailed:function(n){alert(n)}});n.ui.treeDiv.bind("tree.click",function(n){var t=n.node});n.ui.treeDiv.bind("tree.dblclick",function(){console.log(e.node)});n.ui.treeDiv.bind("tree.select",function(t){if(t.node)n.showCommands(t.node);else{var i=t.previous_node;n.ui.selectedPageInput.val(-1);n.ui.cmdBarDiv.hide()}});n.ui.treeDiv.bind("tree.contextmenu",function(n){var t=n.node});n.ui.treeDiv.bind("tree.move",function(t){t.preventDefault();var i=String.format(n.ui.movePagePromptFormat,t.move_info.moved_node.name,t.move_info.position,t.move_info.target_node.name);confirm(i)&&n.moveNode(t.move_info.moved_node,t.move_info.target_node,t.move_info.previous_parent,t.move_info.position)&&t.move_info.do_move()});n.ui.treeDiv.bind("tree.init",function(){});n.ui.treeDiv.bind("tree.open",function(t){n.ui.treeDiv.tree("selectNode",null);n.ui.treeDiv.tree("selectNode",t.node)});n.ui.treeDiv.bind("tree.close",function(t){n.ui.treeDiv.tree("selectNode",null);n.ui.treeDiv.tree("selectNode",t.node)})}};n.init()});